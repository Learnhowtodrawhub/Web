<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <meta name="theme-color" content="#0ea5e9" />
  <title>Learn How to Draw Hub ‚Ä¢ Kids Draw & Color Game</title>

  <style>
    :root{
      --bg:#f8fafc;
      --card:#ffffff;
      --ink:#0f172a;
      --muted:#64748b;

      --sky:#0ea5e9;
      --sky2:#38bdf8;
      --amber:#f59e0b;
      --emerald:#10b981;
      --rose:#fb7185;

      --ring: rgba(14,165,233,.22);
      --shadow: 0 14px 40px rgba(2,6,23,.10);
      --radius: 20px;

      --safe-top: env(safe-area-inset-top);
      --safe-bot: env(safe-area-inset-bottom);
    }

    html, body { height: 100%; }
    body{
      margin:0;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      background: radial-gradient(circle at top, #e0f2fe, var(--bg) 55%);
      color: var(--ink);
      padding-top: var(--safe-top);
      padding-bottom: var(--safe-bot);
      overscroll-behavior: none;
      -webkit-user-select: none;
      user-select: none;
      -webkit-tap-highlight-color: transparent;
      touch-action: manipulation;
    }

    /* Layout */
    .wrap{ max-width: 1050px; margin: 0 auto; padding: 14px; }
    .row{ display:flex; gap:12px; align-items:center; }
    .col{ display:flex; flex-direction:column; gap:12px; }
    .grid{ display:grid; gap:12px; }
    .grid-2{ grid-template-columns: 1fr; }
    .grid-3{ grid-template-columns: 1fr; }
    @media (min-width: 920px){
      .grid-2{ grid-template-columns: 360px 1fr; }
      .grid-3{ grid-template-columns: 1fr 1fr 1fr; }
    }

    .card{
      background: var(--card);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      border: 1px solid rgba(2,6,23,.06);
    }

    /* Top bar */
    .topbar{ padding: 10px 12px; }
    .brand{ display:flex; gap:10px; align-items:center; }
    .logo{
      width: 42px; height: 42px; border-radius: 999px;
      display:flex; align-items:center; justify-content:center;
      background: rgba(14,165,233,.14);
      color: #075985;
      font-weight: 900;
      box-shadow: inset 0 0 0 2px rgba(14,165,233,.18);
    }
    .title{ font-weight: 900; font-size: 16px; line-height: 1.05; }
    .subtitle{ font-size: 12px; color: var(--muted); font-weight: 700; margin-top: 2px; }

    /* Tabs */
    .tabs{ display:flex; gap:8px; align-items:center; flex-wrap:wrap; justify-content:flex-end; }
    .tab{
      padding: 10px 12px;
      border-radius: 14px;
      font-weight: 900;
      font-size: 13px;
      background: rgba(2,6,23,.04);
      border: 1px solid rgba(2,6,23,.06);
      cursor:pointer;
      transition: transform .12s ease, filter .12s ease, background .12s ease;
    }
    .tab:active{ transform: scale(.98); filter: brightness(.98); }
    .tab.active{
      background: rgba(14,165,233,.12);
      border-color: rgba(14,165,233,.25);
      color: #075985;
    }

    /* Buttons */
    .btn{
      display:inline-flex; align-items:center; justify-content:center; gap:8px;
      padding: 12px 14px;
      border-radius: 16px;
      font-weight: 900;
      font-size: 14px;
      border: 1px solid rgba(2,6,23,.08);
      cursor:pointer;
      transition: transform .12s ease, filter .12s ease;
      background: rgba(2,6,23,.04);
      color: var(--ink);
    }
    .btn:active{ transform: scale(.98); filter: brightness(.98); }
    .btn-sky{ background: var(--sky); border-color: rgba(14,165,233,.28); color:#fff; }
    .btn-amber{ background: var(--amber); border-color: rgba(245,158,11,.32); color:#0b1220; }
    .btn-emerald{ background: var(--emerald); border-color: rgba(16,185,129,.30); color:#052016; }
    .btn-ghost{ background: rgba(2,6,23,.03); }
    .btn-small{ padding: 10px 12px; font-size: 13px; border-radius: 14px; }

    /* Pills / stats */
    .pill{
      display:inline-flex; align-items:center; gap:6px;
      padding: 6px 10px;
      border-radius: 999px;
      font-size: 12px;
      font-weight: 900;
      border: 1px solid rgba(2,6,23,.08);
      background: rgba(2,6,23,.03);
      color: var(--ink);
    }
    .pill-sky{ background: rgba(14,165,233,.12); border-color: rgba(14,165,233,.25); color:#075985; }
    .pill-amber{ background: rgba(245,158,11,.14); border-color: rgba(245,158,11,.25); color:#92400e; }
    .pill-emerald{ background: rgba(16,185,129,.14); border-color: rgba(16,185,129,.25); color:#065f46; }
    .pill-rose{ background: rgba(251,113,133,.14); border-color: rgba(251,113,133,.25); color:#9f1239; }

    .kpi{
      padding: 12px;
      border-radius: 18px;
      border: 1px solid rgba(2,6,23,.06);
      background: linear-gradient(180deg, rgba(255,255,255,1), rgba(248,250,252,1));
    }
    .kpi .label{ color: var(--muted); font-size: 12px; font-weight: 900; }
    .kpi .value{ font-size: 18px; font-weight: 1000; margin-top: 4px; }

    /* Lists / cards */
    .list{ display:flex; flex-direction:column; gap:10px; }
    .item{
      padding: 12px;
      border-radius: 18px;
      border: 1px solid rgba(2,6,23,.07);
      background: rgba(255,255,255,.9);
      cursor:pointer;
      transition: transform .12s ease, filter .12s ease;
    }
    .item:hover{ filter: brightness(1.01); }
    .item:active{ transform: scale(.99); }
    .item h4{ margin:0; font-weight: 1000; font-size: 15px; }
    .item p{ margin:6px 0 0 0; color: var(--muted); font-weight: 700; font-size: 12px; }

    /* Input */
    input, select{
      width: 100%;
      padding: 12px 12px;
      border-radius: 16px;
      border: 1px solid rgba(2,6,23,.12);
      outline: none;
      background: #fff;
      font-weight: 800;
      font-size: 14px;
    }
    input:focus, select:focus{
      box-shadow: 0 0 0 6px var(--ring);
      border-color: rgba(14,165,233,.35);
    }

    /* Game stage */
    .stage{
      position: relative;
      width: 100%;
      aspect-ratio: 4 / 3;
      border-radius: 18px;
      overflow: hidden;
      background: linear-gradient(180deg, #ffffff, #f8fafc);
      border: 1px solid rgba(2,6,23,.10);
      box-shadow: inset 0 0 0 2px rgba(14,165,233,.05);
      touch-action: none; /* allow drawing */
    }
    canvas{ position:absolute; inset:0; width:100%; height:100%; }
    .overlayHint{
      position:absolute; inset: 10px auto auto 10px;
      display:flex; gap:8px; align-items:center;
      z-index: 6;
      pointer-events:none;
    }

    /* Score panel */
    .scoreRing{
      width: 82px; height: 82px; border-radius: 999px;
      background: conic-gradient(var(--sky) 0deg, rgba(2,6,23,.08) 0deg);
      display:flex; align-items:center; justify-content:center;
      border: 1px solid rgba(2,6,23,.10);
      box-shadow: inset 0 0 0 8px rgba(255,255,255,.75);
    }
    .scoreRing span{ font-weight: 1000; font-size: 18px; }
    .scoreRow{ display:flex; gap:10px; align-items:center; flex-wrap:wrap; }

    /* Modals */
    .backdrop{
      position: fixed; inset:0;
      background: rgba(15,23,42,.58);
      display:none;
      align-items:center; justify-content:center;
      padding: 14px;
      z-index: 60;
    }
    .backdrop.show{ display:flex; }
    .modal{
      width: min(720px, 100%);
      border-radius: 22px;
      background: #fff;
      box-shadow: 0 18px 70px rgba(0,0,0,.25);
      border: 1px solid rgba(2,6,23,.10);
      overflow:hidden;
    }
    .modalHead{
      padding: 14px 16px;
      border-bottom: 1px solid rgba(2,6,23,.06);
      display:flex; align-items:center; justify-content:space-between;
      gap: 12px;
    }
    .modalBody{ padding: 14px 16px; }
    .muted{ color: var(--muted); font-weight: 700; }
    .tiny{ font-size: 12px; }

    /* Ad slots */
    .adslot{
      display:none;
      border-radius: 18px;
      border: 2px dashed rgba(245,158,11,.55);
      background: rgba(245,158,11,.10);
      min-height: 74px;
      align-items:center; justify-content:center;
      color:#92400e;
      font-weight: 1000;
      letter-spacing:.02em;
      margin-top: 10px;
    }
    .adslot.show{ display:flex; }

    /* Confetti (lightweight) */
    .confetti{
      position: fixed;
      inset: 0;
      pointer-events:none;
      overflow:hidden;
      z-index: 80;
      display:none;
    }
    .confetti.show{ display:block; }
    .confetti i{
      position:absolute;
      top:-20px;
      width: 10px; height: 14px;
      opacity:.9;
      border-radius: 3px;
      animation: fall 1.2s linear forwards;
    }
    @keyframes fall{
      to{ transform: translateY(120vh) rotate(440deg); opacity:1; }
    }

    /* Small helpers */
    .hide{ display:none !important; }
    .space{ height: 8px; }
  </style>
</head>

<body>
  <div class="wrap">
    <!-- Topbar -->
    <div class="card topbar row" style="justify-content:space-between;">
      <div class="brand">
        <div class="logo">üé®</div>
        <div>
          <div class="title">Learn How to Draw Hub</div>
          <div class="subtitle">Gamified Drawing & Coloring Challenges</div>
        </div>
      </div>
      <div class="tabs">
        <button class="tab active" data-tab="play">Play</button>
        <button class="tab" data-tab="leaderboard">Leaderboard</button>
        <button class="tab" data-tab="gallery">Gallery</button>
        <button class="tab" data-tab="rewards">Rewards</button>
        <button class="tab" data-tab="parent">Parent</button>
      </div>
    </div>

    <div class="space"></div>

    <!-- PLAY -->
    <section id="tab-play" class="grid grid-2">
      <!-- Left panel -->
      <div class="col">
        <div class="card" style="padding:14px;">
          <div class="row" style="justify-content:space-between;">
            <span id="pillKids" class="pill pill-sky">Kids Mode</span>
            <span id="pillProfile" class="pill">üôÇ Player</span>
          </div>

          <div class="grid grid-3" style="margin-top:12px;">
            <div class="kpi">
              <div class="label">Level</div>
              <div class="value" id="kpiLevel">1</div>
            </div>
            <div class="kpi">
              <div class="label">XP</div>
              <div class="value" id="kpiXP">0</div>
            </div>
            <div class="kpi">
              <div class="label">Coins</div>
              <div class="value" id="kpiCoins">0</div>
            </div>
          </div>

          <div class="space"></div>

          <div class="card" style="padding:12px; border-radius:18px; border:1px solid rgba(2,6,23,.06); background:rgba(2,6,23,.02);">
            <div class="row" style="justify-content:space-between; align-items:flex-start;">
              <div>
                <div style="font-weight:1000;">Daily Quest</div>
                <div class="muted tiny">Complete today‚Äôs mini chain for bonus coins.</div>
              </div>
              <span id="pillStreak" class="pill pill-emerald">Streak 0</span>
            </div>
            <div class="list" id="dailyQuestList" style="margin-top:10px;"></div>

            <div class="row" style="margin-top:10px;">
              <button id="btnStartQuest" class="btn btn-emerald" style="flex:1;">üöÄ Start Daily Quest</button>
              <button id="btnNewQuest" class="btn btn-ghost btn-small" title="Generate new quest (parent recommended)">üîÅ</button>
            </div>

            <!-- Banner ad only after parent unlock + kids mode off -->
            <div id="adBanner" class="adslot">Banner Ad Slot</div>
          </div>
        </div>

        <div class="card" style="padding:14px;">
          <div class="row" style="justify-content:space-between;">
            <div>
              <div style="font-weight:1000;">Challenges</div>
              <div class="muted tiny">Pick a Draw Sprint or Color Match.</div>
            </div>
            <div class="row">
              <button id="btnRandom" class="btn btn-sky btn-small">üé≤ Random</button>
            </div>
          </div>
          <div class="space"></div>
          <input id="challengeSearch" placeholder="Search (cat, shark, car, princess)..." />
          <div class="space"></div>
          <div id="challengeList" class="list"></div>
        </div>
      </div>

      <!-- Game panel -->
      <div class="col">
        <div class="card" style="padding:14px;">
          <div class="row" style="justify-content:space-between; align-items:flex-start;">
            <div>
              <div id="challengeTitle" style="font-weight:1000; font-size:18px;">Choose a challenge</div>
              <div id="challengeSub" class="muted tiny">Draw Sprint = trace the guide fast. Color Match = match colors accurately.</div>
            </div>
            <div class="row" style="gap:8px; flex-wrap:wrap; justify-content:flex-end;">
              <span id="pillMode" class="pill">‚Äî</span>
              <span id="pillDifficulty" class="pill pill-amber">‚Äî</span>
              <span id="pillTime" class="pill pill-rose">‚è±Ô∏è 0:00</span>
            </div>
          </div>

          <div class="space"></div>

          <div class="stage" id="stage">
            <!-- render layers -->
            <canvas id="baseCanvas"></canvas>     <!-- guide / lineart -->
            <canvas id="userCanvas"></canvas>     <!-- user's drawing -->
            <canvas id="fxCanvas"></canvas>       <!-- flashes / score overlay -->
            <div class="overlayHint">
              <span id="pillGoal" class="pill pill-sky">Goal: ‚Äî</span>
              <span id="pillAccuracy" class="pill pill-amber">Accuracy: ‚Äî</span>
            </div>
          </div>

          <div class="space"></div>

          <!-- Controls -->
          <div class="grid" style="grid-template-columns: 1fr 1fr 1fr; gap:10px;">
            <button id="btnStart" class="btn btn-emerald">‚ñ∂Ô∏è Start</button>
            <button id="btnPause" class="btn btn-ghost">‚è∏ Pause</button>
            <button id="btnFinish" class="btn btn-amber">üèÅ Finish</button>
          </div>

          <div class="space"></div>

          <div class="grid" style="grid-template-columns: 1fr 1fr; gap:10px;">
            <div class="card" style="padding:12px; border-radius:18px;">
              <div class="row" style="justify-content:space-between;">
                <div class="muted tiny">Tool</div>
                <div class="row" style="gap:8px;">
                  <button id="toolBrush" class="btn btn-sky btn-small">üñäÔ∏è Brush</button>
                  <button id="toolEraser" class="btn btn-ghost btn-small">üßΩ Erase</button>
                </div>
              </div>
              <div class="space"></div>
              <div class="row" style="gap:10px;">
                <div style="flex:1;">
                  <div class="muted tiny">Size</div>
                  <input id="brushSize" type="range" min="2" max="28" value="10" />
                </div>
                <div style="width:96px;">
                  <div class="muted tiny">Color</div>
                  <input id="colorPicker" type="color" value="#111827" style="height:44px; padding:6px;" />
                </div>
              </div>

              <div class="space"></div>

              <div class="row" style="gap:10px;">
                <button id="btnUndo" class="btn btn-ghost" style="flex:1;">‚Ü©Ô∏è Undo</button>
                <button id="btnClear" class="btn btn-ghost" style="flex:1;">üóëÔ∏è Clear</button>
              </div>

              <!-- Rewarded ad placement only after parent unlock + kids mode off -->
              <div id="adReward" class="adslot">Rewarded Ad Slot (unlock cosmetics)</div>
            </div>

            <div class="card" style="padding:12px; border-radius:18px;">
              <div class="row" style="justify-content:space-between; align-items:flex-start;">
                <div>
                  <div style="font-weight:1000;">Score</div>
                  <div class="muted tiny">Finish to calculate accuracy + speed + neatness.</div>
                </div>
                <div class="scoreRing" id="scoreRing"><span id="scoreRingText">‚Äî</span></div>
              </div>

              <div class="space"></div>

              <div class="scoreRow">
                <span class="pill pill-amber" id="scoreAcc">üéØ Acc: ‚Äî</span>
                <span class="pill pill-rose" id="scoreTime">‚è±Ô∏è Time: ‚Äî</span>
                <span class="pill pill-sky" id="scoreNeat">‚ú® Neat: ‚Äî</span>
                <span class="pill pill-emerald" id="scoreFinal">üèÜ Final: ‚Äî</span>
              </div>

              <div class="space"></div>

              <div class="row" style="gap:10px;">
                <button id="btnSaveToGallery" class="btn btn-amber" style="flex:1;">üíæ Save</button>
                <button id="btnSharePNG" class="btn btn-ghost" style="flex:1;">üñºÔ∏è Export PNG</button>
              </div>

              <div class="space"></div>

              <div class="muted tiny">
                Leaderboards are <b>local-first</b>. State/Global can be enabled later with a backend (Firebase/Firestore).
              </div>
            </div>
          </div>
        </div>

        <!-- Bottom ‚Äúpro tip‚Äù -->
        <div class="card" style="padding:14px;">
          <div class="row" style="justify-content:space-between; align-items:flex-start;">
            <div>
              <div style="font-weight:1000;">Pro Tip</div>
              <div id="proTip" class="muted tiny">Pick a challenge and hit Start. Try to stay inside the guide!</div>
            </div>
            <span id="pillLeague" class="pill pill-sky">Bronze League</span>
          </div>
        </div>
      </div>
    </section>

    <!-- LEADERBOARD -->
    <section id="tab-leaderboard" class="hide">
      <div class="card" style="padding:14px;">
        <div class="row" style="justify-content:space-between; align-items:flex-start;">
          <div>
            <div style="font-weight:1000; font-size:18px;">Leaderboards</div>
            <div class="muted tiny">Local players on this device + optional State/Global (backend-ready).</div>
          </div>
          <div class="row" style="gap:8px; flex-wrap:wrap; justify-content:flex-end;">
            <select id="lbScope">
              <option value="local">Local (Device)</option>
              <option value="state">State (Backend-ready)</option>
              <option value="global">Global (Backend-ready)</option>
            </select>
            <select id="lbMode">
              <option value="all">All Modes</option>
              <option value="draw">Draw Sprint</option>
              <option value="color">Color Match</option>
            </select>
          </div>
        </div>

        <div class="space"></div>

        <div class="grid grid-3">
          <div class="kpi">
            <div class="label">Best Score</div>
            <div class="value" id="lbBest">‚Äî</div>
          </div>
          <div class="kpi">
            <div class="label">Weekly Points</div>
            <div class="value" id="lbWeekly">‚Äî</div>
          </div>
          <div class="kpi">
            <div class="label">Rank</div>
            <div class="value" id="lbRank">‚Äî</div>
          </div>
        </div>

        <div class="space"></div>

        <div id="lbNote" class="muted tiny"></div>

        <div class="space"></div>

        <div id="lbList" class="list"></div>

        <div class="space"></div>

        <div class="row" style="gap:10px;">
          <button id="btnCreateProfile" class="btn btn-sky">‚ûï Add Local Player</button>
          <button id="btnResetLB" class="btn btn-ghost">üßπ Reset Local Leaderboard</button>
        </div>
      </div>
    </section>

    <!-- GALLERY -->
    <section id="tab-gallery" class="hide">
      <div class="card" style="padding:14px;">
        <div class="row" style="justify-content:space-between; align-items:flex-start;">
          <div>
            <div style="font-weight:1000; font-size:18px;">Gallery</div>
            <div class="muted tiny">Saved drawings & color runs (local device).</div>
          </div>
          <div class="row" style="gap:10px;">
            <button id="btnClearGallery" class="btn btn-ghost">üóëÔ∏è Clear Gallery</button>
          </div>
        </div>

        <div class="space"></div>
        <div id="galleryGrid" class="grid" style="grid-template-columns: repeat(2, 1fr); gap:10px;"></div>
        <div id="galleryEmpty" class="muted tiny hide" style="margin-top:10px;">No saved art yet. Finish a challenge and hit ‚ÄúSave‚Äù.</div>
      </div>
    </section>

    <!-- REWARDS -->
    <section id="tab-rewards" class="hide">
      <div class="card" style="padding:14px;">
        <div class="row" style="justify-content:space-between; align-items:flex-start;">
          <div>
            <div style="font-weight:1000; font-size:18px;">Rewards & Cosmetics</div>
            <div class="muted tiny">Earn coins by playing. Unlock fun frames + brush effects (local).</div>
          </div>
          <span class="pill pill-amber" id="rewardCoinsPill">ü™ô 0</span>
        </div>

        <div class="space"></div>

        <div class="grid grid-3" id="shopGrid"></div>

        <div class="space"></div>

        <div class="card" style="padding:12px; border-radius:18px; background: rgba(2,6,23,.02); border:1px solid rgba(2,6,23,.06);">
          <div style="font-weight:1000;">Unlocked</div>
          <div class="muted tiny" id="unlockedList">‚Äî</div>
        </div>
      </div>
    </section>

    <!-- PARENT -->
    <section id="tab-parent" class="hide">
      <div class="card" style="padding:14px;">
        <div class="row" style="justify-content:space-between; align-items:flex-start;">
          <div>
            <div style="font-weight:1000; font-size:18px;">Parent Settings</div>
            <div class="muted tiny">Protected by a parent gate. No chat. No location. Optional state selection.</div>
          </div>
          <span id="parentLockPill" class="pill pill-rose">üîí Locked</span>
        </div>

        <div class="space"></div>

        <div class="card" style="padding:12px; border-radius:18px; background: rgba(2,6,23,.02); border:1px solid rgba(2,6,23,.06);">
          <div style="font-weight:1000;">Parent Gate</div>
          <div class="muted tiny">Answer the quick math question to unlock settings.</div>
          <div class="space"></div>
          <div class="row" style="gap:10px; flex-wrap:wrap;">
            <span id="gateQ" class="pill pill-amber">‚Äî</span>
            <input id="gateA" inputmode="numeric" placeholder="Answer" style="max-width:180px;" />
            <button id="btnUnlock" class="btn btn-sky btn-small">Unlock</button>
            <button id="btnRelock" class="btn btn-ghost btn-small">Relock</button>
          </div>
          <div id="gateMsg" class="muted tiny" style="margin-top:8px;"></div>
        </div>

        <div class="space"></div>

        <div id="parentSettings" class="hide">
          <div class="grid grid-2">
            <div class="card" style="padding:12px; border-radius:18px;">
              <div style="font-weight:1000;">Kids Mode</div>
              <div class="muted tiny">ON hides ads + disables outbound links & ‚Äústate/global‚Äù leaderboard network calls.</div>
              <div class="space"></div>
              <div class="row" style="gap:10px;">
                <button id="btnKidsOn" class="btn btn-emerald" style="flex:1;">Kids Mode ON</button>
                <button id="btnKidsOff" class="btn btn-ghost" style="flex:1;">Kids Mode OFF</button>
              </div>

              <div class="space"></div>

              <div style="font-weight:1000;">State (Optional)</div>
              <div class="muted tiny">This is parent-selected (no GPS). Used only if you later enable online leaderboards.</div>
              <div class="space"></div>
              <select id="stateSelect"></select>

              <div class="space"></div>

              <div style="font-weight:1000;">AdMob Hooks</div>
              <div class="muted tiny">AdMob is native (Capacitor/WKWebView). These buttons call JS hooks you wire to a plugin.</div>
              <div class="space"></div>
              <div class="row" style="gap:10px; flex-wrap:wrap;">
                <button class="btn btn-ghost btn-small" id="btnShowBanner">Show Banner</button>
                <button class="btn btn-ghost btn-small" id="btnHideBanner">Hide Banner</button>
                <button class="btn btn-ghost btn-small" id="btnInterstitial">Interstitial</button>
                <button class="btn btn-ghost btn-small" id="btnRewarded">Rewarded</button>
              </div>

              <div class="space"></div>
              <div class="muted tiny">
                For kids-directed apps, ads must be configured as <b>non-personalized</b> and compliant (no manipulation, no ‚Äúwatch ad to continue‚Äù loops).
              </div>
            </div>

            <div class="card" style="padding:12px; border-radius:18px;">
              <div style="font-weight:1000;">Profiles (Local)</div>
              <div class="muted tiny">Add multiple kids on one device. Leaderboard compares local players.</div>
              <div class="space"></div>
              <div id="profileList" class="list"></div>
              <div class="space"></div>
              <button id="btnAddProfile" class="btn btn-sky">‚ûï Add Profile</button>

              <div class="space"></div>

              <div style="font-weight:1000;">Reset</div>
              <div class="muted tiny">Clears local game data, gallery, profiles, and scores.</div>
              <div class="space"></div>
              <button id="btnResetAll" class="btn btn-amber">üß® Reset All App Data</button>
            </div>
          </div>
        </div>
      </div>
    </section>
  </div>

  <!-- Modal: Results -->
  <div id="resultBackdrop" class="backdrop">
    <div class="modal">
      <div class="modalHead">
        <div>
          <div style="font-weight:1000;">Challenge Result</div>
          <div class="muted tiny" id="resultTitle">‚Äî</div>
        </div>
        <button class="btn btn-ghost btn-small" id="btnCloseResult">Close</button>
      </div>
      <div class="modalBody">
        <div class="row" style="gap:12px; flex-wrap:wrap;">
          <div class="scoreRing" id="modalRing"><span id="modalRingText">‚Äî</span></div>
          <div class="col" style="flex:1;">
            <div class="scoreRow">
              <span class="pill pill-amber" id="mAcc">üéØ Acc: ‚Äî</span>
              <span class="pill pill-rose" id="mTime">‚è±Ô∏è Time: ‚Äî</span>
              <span class="pill pill-sky" id="mNeat">‚ú® Neat: ‚Äî</span>
              <span class="pill pill-emerald" id="mFinal">üèÜ Final: ‚Äî</span>
            </div>
            <div class="space"></div>
            <div class="muted tiny" id="mReward">‚Äî</div>
          </div>
        </div>

        <div class="space"></div>

        <div class="row" style="gap:10px; flex-wrap:wrap;">
          <button id="btnNextChallenge" class="btn btn-emerald" style="flex:1;">Next Challenge</button>
          <button id="btnReplay" class="btn btn-sky" style="flex:1;">Replay</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Confetti -->
  <div id="confetti" class="confetti"></div>

<script>
/* =========================================================
   LearnHowToDrawHub ‚Ä¢ Gamified Draw + Color ‚Ä¢ Offline-first
   - Draw Sprint: trace guide quickly & neatly
   - Color Match: match target colors accurately + speed bonus
   - Scores stored locally; state/global are backend-ready (optional)
   - Kids Mode by default (ads hidden, outbound links disabled)
   ========================================================= */

(() => {
  // ---------- Storage Keys ----------
  const K = {
    root: 'lhd_app_v1',
    kids: 'lhd_kidsMode',
    unlocked: 'lhd_parentUnlocked',
    state: 'lhd_state',
    profiles: 'lhd_profiles',
    activeProfile: 'lhd_activeProfile',
    progress: 'lhd_progress',
    gallery: 'lhd_gallery',
    leaderboard: 'lhd_leaderboard',
    shop: 'lhd_shop',
    daily: 'lhd_dailyQuest',
  };

  // ---------- Helpers ----------
  const $ = (id) => document.getElementById(id);
  const clamp = (v, a, b) => Math.max(a, Math.min(b, v));
  const fmtTime = (ms) => {
    const s = Math.max(0, Math.floor(ms/1000));
    const m = Math.floor(s/60);
    const r = s%60;
    return `${m}:${String(r).padStart(2,'0')}`;
  };
  const todayKey = () => {
    const d = new Date();
    return `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}-${String(d.getDate()).padStart(2,'0')}`;
  };
  const uid = () => Math.random().toString(16).slice(2) + Date.now().toString(16);

  function readJSON(key, fallback){
    try{
      const v = localStorage.getItem(key);
      return v ? JSON.parse(v) : fallback;
    }catch(e){ return fallback; }
  }
  function writeJSON(key, val){
    localStorage.setItem(key, JSON.stringify(val));
  }

  function vibrate(ms=12){
    try{ if(navigator.vibrate) navigator.vibrate(ms); }catch(e){}
  }

  // ---------- App State ----------
  const S = {
    kidsMode: true,
    parentUnlocked: false,
    selectedState: 'TX',

    profiles: [],
    activeProfileId: null,

    progress: { xp:0, coins:0, streak:0, lastQuestDay:null, unlockedCosmetics:[], equippedFrame:'none' },

    // Game session
    challenge: null,
    running: false,
    paused: false,
    startMs: 0,
    pauseMs: 0,
    elapsedMs: 0,
    strokeCount: 0,
    undo: [],
    maxUndo: 28,

    // Tooling
    tool: 'brush',     // brush | eraser
    size: 10,
    color: '#111827',

    // Render sizes
    cssW: 0, cssH: 0, dpr: 1,

    // Leaderboard
    leaderboard: { entries: [] }, // stored locally
  };

  // ---------- Challenges (offline-friendly) ----------
  // Put your own PNGs in:
  //  - assets/draw/<id>_guide.png  (transparent guide lines)
  //  - assets/draw/<id>_mask.png   (optional; white=allowed region, transparent outside)
  //  - assets/color/<id>_target.png (colored target)
  //  - assets/color/<id>_line.png   (lineart overlay)
  //  - assets/color/<id>_mask.png   (optional)
  //
  // If images are missing, the app generates a simple target/mask so everything still works.
  const CHALLENGES = [
    { id:'cat', type:'draw',  title:'Cute Cat Sprint',      tags:['cat','animal','easy'], difficulty:'Easy', timeLimit: 60000, goal:'Trace the cat guide neatly.' },
    { id:'shark', type:'draw', title:'Shark Face Sprint',   tags:['shark','ocean','medium'], difficulty:'Medium', timeLimit: 75000, goal:'Stay inside the guide lines.' },
    { id:'car', type:'draw',   title:'Race Car Sprint',     tags:['car','vehicle','medium'], difficulty:'Medium', timeLimit: 80000, goal:'Fast + clean strokes!' },

    { id:'sunset', type:'color', title:'Color Match: Sunset', tags:['color','sunset','easy'], difficulty:'Easy', timeLimit: 90000, goal:'Match the colors accurately.' },
    { id:'jungle', type:'color', title:'Color Match: Jungle', tags:['color','jungle','medium'], difficulty:'Medium', timeLimit: 105000, goal:'Accuracy + speed bonus.' },
    { id:'space',  type:'color', title:'Color Match: Space',  tags:['color','space','hard'], difficulty:'Hard', timeLimit: 120000, goal:'Hard mode tolerance!' }
  ];

  const TOL_BY_DIFF = { Easy: 78, Medium: 56, Hard: 38 }; // color distance tolerance
  const SPILL_PENALTY_BY_DIFF = { Easy: 0.10, Medium: 0.16, Hard: 0.22 };

  // ---------- Canvas + Layers ----------
  const base = $('baseCanvas');
  const user = $('userCanvas');
  const fx   = $('fxCanvas');
  const stage = $('stage');
  const bctx = base.getContext('2d');
  const uctx = user.getContext('2d', { alpha:true });
  const fctx = fx.getContext('2d', { alpha:true });

  // Offscreen for scoring
  const off = document.createElement('canvas');
  const off2 = document.createElement('canvas');
  const octx = off.getContext('2d');
  const octx2 = off2.getContext('2d');

  // Loaded assets cache
  const ASSET = new Map();

  async function loadImage(path){
    if(ASSET.has(path)) return ASSET.get(path);
    const img = new Image();
    img.crossOrigin = 'anonymous';
    const p = new Promise((resolve) => {
      img.onload = () => resolve(img);
      img.onerror = () => resolve(null);
    });
    img.src = path;
    const out = await p;
    ASSET.set(path, out);
    return out;
  }

  function resizeCanvases(){
    const rect = stage.getBoundingClientRect();
    const dpr = clamp(window.devicePixelRatio || 1, 1, 3);

    S.cssW = Math.floor(rect.width);
    S.cssH = Math.floor(rect.height);
    S.dpr = dpr;

    const w = Math.floor(rect.width * dpr);
    const h = Math.floor(rect.height * dpr);

    [base,user,fx].forEach(c => { c.width = w; c.height = h; });

    // draw in CSS pixels for easier input math
    [bctx,uctx,fctx].forEach(ctx => {
      ctx.setTransform(1,0,0,1,0,0);
      ctx.scale(dpr,dpr);
      ctx.imageSmoothingEnabled = true;
    });

    // After resize, keep content minimal: clear + rerender current base
    clearUser(true);
    renderBase();
    renderFX(true);
  }
  window.addEventListener('resize', resizeCanvases);

  // ---------- UI Wiring ----------
  const tabs = Array.from(document.querySelectorAll('.tab'));
  const tabSections = {
    play: $('tab-play'),
    leaderboard: $('tab-leaderboard'),
    gallery: $('tab-gallery'),
    rewards: $('tab-rewards'),
    parent: $('tab-parent'),
  };
  function showTab(name){
    tabs.forEach(t => t.classList.toggle('active', t.dataset.tab === name));
    Object.keys(tabSections).forEach(k => tabSections[k].classList.toggle('hide', k !== name));
  }
  tabs.forEach(t => t.addEventListener('click', () => showTab(t.dataset.tab)));

  // Buttons / inputs
  $('btnRandom').addEventListener('click', () => {
    const picks = filteredChallenges();
    if(!picks.length) return;
    const c = picks[Math.floor(Math.random()*picks.length)];
    selectChallenge(c.id);
  });
  $('challengeSearch').addEventListener('input', renderChallengeList);

  $('btnStart').addEventListener('click', startRun);
  $('btnPause').addEventListener('click', togglePause);
  $('btnFinish').addEventListener('click', finishRun);

  $('toolBrush').addEventListener('click', () => setTool('brush'));
  $('toolEraser').addEventListener('click', () => setTool('eraser'));
  $('brushSize').addEventListener('input', (e)=> S.size = parseInt(e.target.value,10));
  $('colorPicker').addEventListener('input', (e)=> S.color = e.target.value);

  $('btnUndo').addEventListener('click', undo);
  $('btnClear').addEventListener('click', () => clearUser(false));

  $('btnSaveToGallery').addEventListener('click', saveToGallery);
  $('btnSharePNG').addEventListener('click', exportPNG);

  $('btnCloseResult').addEventListener('click', closeResult);
  $('btnNextChallenge').addEventListener('click', () => { closeResult(); nextChallenge(); });
  $('btnReplay').addEventListener('click', () => { closeResult(); replayChallenge(); });

  // Daily quest
  $('btnStartQuest').addEventListener('click', startDailyQuest);
  $('btnNewQuest').addEventListener('click', () => {
    if(!S.parentUnlocked) {
      toast('Parent recommended: unlock Parent settings to regenerate quests.');
      return;
    }
    generateDailyQuest(true);
  });

  // Leaderboards
  $('lbScope').addEventListener('change', renderLeaderboard);
  $('lbMode').addEventListener('change', renderLeaderboard);
  $('btnResetLB').addEventListener('click', () => {
    if(!confirmSafe('Reset local leaderboard?')) return;
    S.leaderboard.entries = [];
    persistLeaderboard();
    renderLeaderboard();
    toast('Local leaderboard reset.');
  });
  $('btnCreateProfile').addEventListener('click', () => {
    addProfile();
    renderProfiles();
    renderLeaderboard();
  });

  // Gallery
  $('btnClearGallery').addEventListener('click', () => {
    if(!confirmSafe('Clear gallery?')) return;
    writeJSON(K.gallery, []);
    renderGallery();
  });

  // Parent gate
  $('btnUnlock').addEventListener('click', parentUnlockAttempt);
  $('btnRelock').addEventListener('click', () => setParentUnlocked(false));
  $('btnKidsOn').addEventListener('click', () => setKidsMode(true));
  $('btnKidsOff').addEventListener('click', () => setKidsMode(false));
  $('stateSelect').addEventListener('change', (e) => {
    S.selectedState = e.target.value;
    localStorage.setItem(K.state, S.selectedState);
    toast(`State set to ${S.selectedState}.`);
    renderLeaderboard();
  });

  // Ad hooks (wire to native later)
  $('btnShowBanner').addEventListener('click', () => Ads.showBanner());
  $('btnHideBanner').addEventListener('click', () => Ads.hideBanner());
  $('btnInterstitial').addEventListener('click', () => Ads.showInterstitial());
  $('btnRewarded').addEventListener('click', () => Ads.showRewarded());

  // Profiles
  $('btnAddProfile').addEventListener('click', () => { addProfile(); renderProfiles(); });
  $('btnResetAll').addEventListener('click', () => {
    if(!confirmSafe('Reset ALL app data?')) return;
    Object.values(K).forEach(k => localStorage.removeItem(k));
    location.reload();
  });

  // Rewards shop
  const SHOP_ITEMS = [
    { id:'frame_sky', name:'Sky Frame', cost: 120, desc:'A bright sky border for your art.' },
    { id:'frame_amber', name:'Amber Frame', cost: 160, desc:'Warm golden frame ‚Äî looks premium.' },
    { id:'frame_emerald', name:'Emerald Frame', cost: 200, desc:'Green glow frame for big wins!' },
    { id:'sparkle_fx', name:'Sparkle FX', cost: 250, desc:'Tiny sparkles when you finish.' },
    { id:'neon_brush', name:'Neon Brush', cost: 300, desc:'A special glowing brush style.' },
    { id:'sticker_pack1', name:'Sticker Pack', cost: 180, desc:'More stickers for rewards.' },
  ];

  // ---------- Drawing Input ----------
  let pointerDown = false;
  let lastPt = null;

  function getPt(evt){
    const r = stage.getBoundingClientRect();
    return { x: (evt.clientX - r.left), y: (evt.clientY - r.top) };
  }

  function pushUndo(){
    try{
      const data = user.toDataURL('image/png');
      S.undo.push(data);
      if(S.undo.length > S.maxUndo) S.undo.shift();
    }catch(e){}
  }

  function undo(){
    if(!S.undo.length) return;
    const data = S.undo.pop();
    const img = new Image();
    img.onload = () => {
      clearUser(true);
      // draw in CSS pixels
      uctx.drawImage(img, 0, 0, S.cssW, S.cssH);
    };
    img.src = data;
    vibrate(8);
  }

  function clearUser(skipUndo){
    if(!skipUndo) pushUndo();
    uctx.clearRect(0,0,S.cssW,S.cssH);
    S.strokeCount = 0;
  }

  function drawDot(x,y){
    const s = S.size;
    if(S.tool === 'eraser'){
      uctx.save();
      uctx.globalCompositeOperation = 'destination-out';
      uctx.beginPath();
      uctx.arc(x, y, s/2, 0, Math.PI*2);
      uctx.fill();
      uctx.restore();
    }else{
      uctx.fillStyle = S.color;
      uctx.beginPath();
      uctx.arc(x, y, s/2, 0, Math.PI*2);
      uctx.fill();
    }
  }

  function drawLine(x1,y1,x2,y2){
    uctx.lineCap = 'round';
    uctx.lineJoin = 'round';
    uctx.lineWidth = S.size;
    if(S.tool === 'eraser'){
      uctx.save();
      uctx.globalCompositeOperation = 'destination-out';
      uctx.strokeStyle = 'rgba(0,0,0,1)';
      uctx.beginPath();
      uctx.moveTo(x1,y1);
      uctx.lineTo(x2,y2);
      uctx.stroke();
      uctx.restore();
    }else{
      uctx.strokeStyle = S.color;
      uctx.beginPath();
      uctx.moveTo(x1,y1);
      uctx.lineTo(x2,y2);
      uctx.stroke();
    }
  }

  function pointerStart(evt){
    if(!S.challenge) return;
    if(!S.running || S.paused) return;
    evt.preventDefault();
    pointerDown = true;
    pushUndo();
    S.strokeCount++;
    lastPt = getPt(evt);
    drawDot(lastPt.x, lastPt.y);
  }

  function pointerMove(evt){
    if(!pointerDown) return;
    if(!S.running || S.paused) return;
    evt.preventDefault();
    const p = getPt(evt);
    drawLine(lastPt.x, lastPt.y, p.x, p.y);
    lastPt = p;
  }

  function pointerEnd(evt){
    if(!pointerDown) return;
    evt.preventDefault();
    pointerDown = false;
    lastPt = null;
  }

  stage.addEventListener('pointerdown', pointerStart, { passive:false });
  stage.addEventListener('pointermove', pointerMove, { passive:false });
  stage.addEventListener('pointerup', pointerEnd, { passive:false });
  stage.addEventListener('pointercancel', pointerEnd, { passive:false });
  stage.addEventListener('pointerleave', pointerEnd, { passive:false });

  // ---------- Rendering Base (Guide / Lineart) ----------
  async function renderBase(){
    bctx.clearRect(0,0,S.cssW,S.cssH);
    fctx.clearRect(0,0,S.cssW,S.cssH);

    if(!S.challenge){
      // nice empty state
      bctx.save();
      bctx.fillStyle = 'rgba(2,6,23,.03)';
      bctx.fillRect(0,0,S.cssW,S.cssH);
      bctx.fillStyle = 'rgba(2,6,23,.45)';
      bctx.font = '900 16px system-ui';
      bctx.fillText('Pick a challenge to begin!', 18, 32);
      bctx.restore();
      return;
    }

    const c = S.challenge;
    if(c.type === 'draw'){
      // Guide: transparent line art, dark gray
      const guidePath = `assets/draw/${c.id}_guide.png`;
      const guideImg = await loadImage(guidePath);

      if(guideImg){
        // Fit cover-like but keep aspect: contain within stage
        drawContain(bctx, guideImg, S.cssW, S.cssH, 0.88);
      }else{
        // Fallback: procedural guide
        drawProceduralGuide(bctx, c.id, S.cssW, S.cssH);
      }
      // Make guide slightly lighter (kid-friendly)
      bctx.save();
      bctx.globalAlpha = 0.35;
      bctx.fillStyle = '#0f172a';
      bctx.restore();
    }else{
      // Color mode: show line art overlay + tiny target preview corner
      const linePath = `assets/color/${c.id}_line.png`;
      const targetPath = `assets/color/${c.id}_target.png`;

      const lineImg = await loadImage(linePath);
      const targetImg = await loadImage(targetPath);

      // Background
      bctx.save();
      bctx.fillStyle = '#ffffff';
      bctx.fillRect(0,0,S.cssW,S.cssH);
      bctx.restore();

      if(lineImg){
        drawContain(bctx, lineImg, S.cssW, S.cssH, 0.90, true);
      }else{
        drawProceduralLineArt(bctx, c.id, S.cssW, S.cssH);
      }

      // Target preview (top-right)
      bctx.save();
      const pw = Math.max(90, Math.floor(S.cssW * 0.22));
      const ph = Math.floor(pw * 0.75);
      const x = S.cssW - pw - 10;
      const y = 10;
      bctx.fillStyle = 'rgba(255,255,255,.92)';
      roundRect(bctx, x-6, y-6, pw+12, ph+12, 14);
      bctx.fill();
      bctx.strokeStyle = 'rgba(2,6,23,.10)';
      bctx.lineWidth = 1;
      bctx.stroke();

      if(targetImg){
        drawContainInRect(bctx, targetImg, x, y, pw, ph);
      }else{
        drawProceduralTargetPreview(bctx, c.id, x, y, pw, ph);
      }
      bctx.fillStyle = 'rgba(2,6,23,.60)';
      bctx.font = '900 12px system-ui';
      bctx.fillText('MATCH THIS', x+8, y+14);
      bctx.restore();
    }
  }

  function renderFX(clearOnly){
    fctx.clearRect(0,0,S.cssW,S.cssH);
    if(clearOnly) return;

    // Frame cosmetic
    const frame = S.progress.equippedFrame || 'none';
    if(frame !== 'none'){
      fctx.save();
      const inset = 10;
      fctx.lineWidth = 10;
      fctx.globalAlpha = 0.85;
      fctx.strokeStyle = frame.includes('sky') ? 'rgba(14,165,233,.55)'
                    : frame.includes('amber') ? 'rgba(245,158,11,.55)'
                    : frame.includes('emerald') ? 'rgba(16,185,129,.55)'
                    : 'rgba(2,6,23,.15)';
      roundRect(fctx, inset, inset, S.cssW - inset*2, S.cssH - inset*2, 18);
      fctx.stroke();
      fctx.restore();
    }
  }

  // ---------- Challenge List ----------
  function filteredChallenges(){
    const q = ($('challengeSearch').value || '').trim().toLowerCase();
    return CHALLENGES.filter(c => {
      if(!q) return true;
      return c.title.toLowerCase().includes(q) || (c.tags||[]).join(' ').toLowerCase().includes(q);
    });
  }

  function renderChallengeList(){
    const list = $('challengeList');
    list.innerHTML = '';

    const items = filteredChallenges();
    if(!items.length){
      const div = document.createElement('div');
      div.className = 'muted tiny';
      div.textContent = 'No challenges match your search.';
      list.appendChild(div);
      return;
    }

    items.forEach(c => {
      const div = document.createElement('div');
      div.className = 'item';
      div.innerHTML = `
        <div class="row" style="justify-content:space-between; align-items:flex-start;">
          <div style="flex:1;">
            <h4>${escapeHtml(c.title)}</h4>
            <p>${escapeHtml(c.goal)} ‚Ä¢ ${c.type === 'draw' ? 'Draw Sprint' : 'Color Match'}</p>
          </div>
          <div class="col" style="gap:6px; align-items:flex-end;">
            <span class="pill ${c.type==='draw'?'pill-sky':'pill-amber'}">${c.type==='draw'?'‚úçÔ∏è Draw':'üß© Color'}</span>
            <span class="pill pill-amber">${escapeHtml(c.difficulty)}</span>
          </div>
        </div>
      `;
      div.addEventListener('click', () => selectChallenge(c.id));
      list.appendChild(div);
    });
  }

  async function selectChallenge(id){
    const c = CHALLENGES.find(x => x.id === id);
    if(!c) return;

    S.challenge = c;
    S.running = false;
    S.paused = false;
    S.elapsedMs = 0;
    S.strokeCount = 0;
    S.undo = [];
    clearUser(true);

    $('challengeTitle').textContent = c.title;
    $('challengeSub').textContent = c.goal;
    $('pillMode').textContent = c.type === 'draw' ? '‚úçÔ∏è Draw Sprint' : 'üß© Color Match';
    $('pillDifficulty').textContent = c.difficulty;
    $('pillTime').textContent = `‚è±Ô∏è ${fmtTime(c.timeLimit)}`;
    $('pillGoal').textContent = `Goal: ${c.type === 'draw' ? 'Trace' : 'Match Colors'}`;
    $('pillAccuracy').textContent = `Accuracy: ‚Äî`;
    $('proTip').textContent = c.type === 'draw'
      ? 'Try smooth strokes. Staying inside the guide boosts accuracy.'
      : 'Use the preview in the top-right. Accuracy matters more than speed on hard mode.';

    setScoreUI(null);
    await renderBase();
    renderFX(false);
  }

  // ---------- Timer Loop ----------
  let raf = null;
  function tick(){
    if(!S.running){ raf = null; return; }
    if(!S.paused){
      S.elapsedMs = Date.now() - S.startMs;
      const remain = Math.max(0, S.challenge.timeLimit - S.elapsedMs);
      $('pillTime').textContent = `‚è±Ô∏è ${fmtTime(remain)}`;
      if(remain <= 0){
        finishRun();
        return;
      }
    }
    raf = requestAnimationFrame(tick);
  }

  function startRun(){
    if(!S.challenge){ toast('Pick a challenge first.'); return; }
    if(S.running && !S.paused) return;

    // Start or resume
    if(!S.running){
      S.running = true;
      S.paused = false;
      S.startMs = Date.now();
      S.elapsedMs = 0;
      S.strokeCount = 0;
      S.undo = [];
      clearUser(true);
      toast('Go go go! üéÆ');
    }else{
      // resume
      S.paused = false;
      // adjust startMs so elapsed continues
      S.startMs = Date.now() - S.elapsedMs;
      toast('Resumed ‚úÖ');
    }

    vibrate(12);
    if(!raf) raf = requestAnimationFrame(tick);
  }

  function togglePause(){
    if(!S.running) return;
    S.paused = !S.paused;
    if(S.paused){
      toast('Paused ‚è∏');
      vibrate(10);
    }else{
      S.startMs = Date.now() - S.elapsedMs;
      toast('Resumed ‚úÖ');
      vibrate(10);
      if(!raf) raf = requestAnimationFrame(tick);
    }
  }

  async function finishRun(){
    if(!S.challenge){ return; }
    if(!S.running){ toast('Press Start first.'); return; }
    S.running = false;
    S.paused = false;
    if(raf){ cancelAnimationFrame(raf); raf = null; }

    // Calculate score
    const ms = clamp(S.elapsedMs, 1, S.challenge.timeLimit);
    const result = await scoreChallenge(S.challenge, ms);

    // Apply rewards
    applyRewards(result);

    // Save leaderboard
    addLeaderboardEntry(result);

    // Update UI
    setScoreUI(result);
    showResultModal(result);

    // Confetti for big scores
    if(result.finalScore >= 85) popConfetti();
  }

  // ---------- Scoring ----------
  async function scoreChallenge(ch, elapsedMs){
    // Render to smaller buffers for speed
    const W = 256, H = 192;
    off.width = W; off.height = H;
    off2.width = W; off2.height = H;

    // Draw base guide/line and user to offscreen
    octx.clearRect(0,0,W,H);
    octx2.clearRect(0,0,W,H);

    // USER to off2
    octx2.drawImage(user, 0, 0, user.width/S.dpr, user.height/S.dpr, 0, 0, W, H);
    const userData = octx2.getImageData(0,0,W,H).data;

    // Create MASK + TARGET depending on type
    let maskData = null;
    let targetData = null;

    if(ch.type === 'draw'){
      // Mask from explicit mask image OR from guide alpha
      const maskImg = await loadImage(`assets/draw/${ch.id}_mask.png`);
      if(maskImg){
        octx.drawImage(maskImg, 0, 0, maskImg.width, maskImg.height, 0, 0, W, H);
      }else{
        const guideImg = await loadImage(`assets/draw/${ch.id}_guide.png`);
        if(guideImg){
          octx.drawImage(guideImg, 0, 0, guideImg.width, guideImg.height, 0, 0, W, H);
        }else{
          // procedural mask from guide
          drawProceduralGuide(octx, ch.id, W, H, true);
        }
      }
      maskData = octx.getImageData(0,0,W,H).data;

      // Score: coverage inside mask vs spill outside, plus neatness
      const { coverage, spill, ink } = measureCoverage(userData, maskData, W, H);
      const difficultySpill = SPILL_PENALTY_BY_DIFF[ch.difficulty] ?? 0.14;

      // Completion: normalized coverage
      let acc = clamp(coverage * 100, 0, 100);

      // Spill penalty
      const spillPenalty = clamp(spill / Math.max(1, ink), 0, 1) * (difficultySpill * 100);
      acc = clamp(acc - spillPenalty, 0, 100);

      // Neatness: fewer strokes for same ink = better (softly)
      const neat = neatnessScore(S.strokeCount, ink);

      // Speed bonus: (time left) scaled, harder = less bonus
      const speed = speedBonus(elapsedMs, ch.timeLimit, ch.difficulty);

      const finalScore = clamp(Math.round(acc*0.72 + neat*0.14 + speed*0.14), 0, 100);

      return {
        id: uid(),
        type: ch.type,
        challengeId: ch.id,
        title: ch.title,
        difficulty: ch.difficulty,
        elapsedMs,
        accuracy: Math.round(acc),
        neatness: Math.round(neat),
        speed: Math.round(speed),
        finalScore,
        timestamp: Date.now(),
        profileId: S.activeProfileId,
      };

    } else {
      // COLOR: compare user canvas to target image within mask
      // Target
      const targetImg = await loadImage(`assets/color/${ch.id}_target.png`);
      octx.clearRect(0,0,W,H);
      if(targetImg){
        octx.drawImage(targetImg, 0,0,targetImg.width,targetImg.height, 0,0,W,H);
      }else{
        drawProceduralTarget(octx, ch.id, W, H);
      }
      targetData = octx.getImageData(0,0,W,H).data;

      // Mask
      const maskImg = await loadImage(`assets/color/${ch.id}_mask.png`);
      octx.clearRect(0,0,W,H);
      if(maskImg){
        octx.drawImage(maskImg, 0,0,maskImg.width,maskImg.height, 0,0,W,H);
      }else{
        // derive from line art alpha if exists, else allow full canvas except margin
        const lineImg = await loadImage(`assets/color/${ch.id}_line.png`);
        if(lineImg){
          octx.drawImage(lineImg, 0,0,lineImg.width,lineImg.height, 0,0,W,H);
        }else{
          drawProceduralMask(octx, ch.id, W, H);
        }
      }
      maskData = octx.getImageData(0,0,W,H).data;

      const tol = TOL_BY_DIFF[ch.difficulty] ?? 56;
      const spillWeight = SPILL_PENALTY_BY_DIFF[ch.difficulty] ?? 0.16;

      const { accuracyPct, spillPct, filledPct } = colorAccuracy(userData, targetData, maskData, W, H, tol);

      // Encourage coloring enough area (so kids can‚Äôt ‚Äúdo nothing‚Äù for 100%)
      const fillBoost = clamp((filledPct - 0.06) / 0.60, 0, 1); // if they colored >6% area, scale up
      let acc = clamp(accuracyPct * (0.70 + 0.30*fillBoost), 0, 100);

      // spill penalty (soft)
      acc = clamp(acc - (spillPct * spillWeight * 100), 0, 100);

      const neat = neatnessScore(S.strokeCount, filledPct * 255 * W * H);
      const speed = speedBonus(elapsedMs, ch.timeLimit, ch.difficulty);

      const finalScore = clamp(Math.round(acc*0.78 + neat*0.10 + speed*0.12), 0, 100);

      return {
        id: uid(),
        type: ch.type,
        challengeId: ch.id,
        title: ch.title,
        difficulty: ch.difficulty,
        elapsedMs,
        accuracy: Math.round(acc),
        neatness: Math.round(neat),
        speed: Math.round(speed),
        finalScore,
        timestamp: Date.now(),
        profileId: S.activeProfileId,
      };
    }
  }

  function measureCoverage(userData, maskData, W, H){
    // mask: use alpha > 18 => allowed region
    // user ink: user alpha > 24
    let maskCount = 0;
    let insideInk = 0;
    let spillInk = 0;
    let ink = 0;

    for(let i=0;i<W*H;i++){
      const mi = i*4;
      const ma = maskData[mi+3];
      const ua = userData[mi+3];
      const inMask = ma > 18;
      const hasInk = ua > 24;

      if(inMask) maskCount++;
      if(hasInk){
        ink++;
        if(inMask) insideInk++;
        else spillInk++;
      }
    }

    // coverage: how much of mask is hit by ink (not perfect, but works for tracing)
    const coverage = maskCount ? insideInk / maskCount : 0;
    return { coverage, spill: spillInk, ink };
  }

  function neatnessScore(strokes, inkPixels){
    // Normalize: fewer strokes per ink = higher
    // Gentle curve so kids aren‚Äôt punished
    const s = Math.max(1, strokes);
    const ink = Math.max(1, inkPixels);
    const ratio = s / Math.sqrt(ink); // higher ratio => more scratchy
    const neat = 100 - clamp((ratio - 0.6) * 45, 0, 45); // usually 70-100
    return clamp(neat, 55, 100);
  }

  function speedBonus(elapsed, limit, diff){
    const left = clamp(1 - (elapsed/limit), 0, 1);
    const diffFactor = diff === 'Hard' ? 0.85 : diff === 'Medium' ? 0.95 : 1.0;
    // Nonlinear so early finishes feel great
    return clamp(100 * Math.pow(left, 0.55) * diffFactor, 0, 100);
  }

  function colorAccuracy(userData, targetData, maskData, W, H, tol){
    // mask: alpha > 18
    // scoring: pixelScore = clamp(1 - dist/tol, 0, 1) where dist is RGB distance
    // spill: user ink where mask is false
    let total = 0;
    let sum = 0;
    let spill = 0;
    let filled = 0;

    for(let i=0;i<W*H;i++){
      const p = i*4;
      const ma = maskData[p+3];
      const inMask = ma > 18;

      const ur = userData[p], ug = userData[p+1], ub = userData[p+2], ua = userData[p+3];
      const tr = targetData[p], tg = targetData[p+1], tb = targetData[p+2], ta = targetData[p+3];

      const hasInk = ua > 24;
      if(hasInk) filled++;

      if(!inMask){
        if(hasInk) spill++;
        continue;
      }

      // If target is transparent here, treat as out-of-scope.
      if(ta < 8){
        total++;
        // prefer empty (white) - but don‚Äôt punish much
        const emptyScore = hasInk ? 0.65 : 1.0;
        sum += emptyScore;
        continue;
      }

      total++;

      // Compare colors
      // If user did nothing, score is low but not zero (kids can be slow)
      if(!hasInk){
        sum += 0.35;
        continue;
      }

      const dr = ur - tr, dg = ug - tg, db = ub - tb;
      const dist = Math.sqrt(dr*dr + dg*dg + db*db);
      const score = clamp(1 - (dist / tol), 0, 1);
      sum += score;
    }

    const accuracyPct = total ? (sum/total)*100 : 0;
    const spillPct = (W*H) ? spill/(W*H) : 0;
    const filledPct = (W*H) ? filled/(W*H) : 0;

    return { accuracyPct, spillPct, filledPct };
  }

  // ---------- Rewards, Progress, League ----------
  function applyRewards(result){
    // XP based on final score + difficulty
    const diffMult = result.difficulty === 'Hard' ? 1.4 : result.difficulty === 'Medium' ? 1.2 : 1.0;
    const xpEarn = Math.round((8 + result.finalScore) * diffMult);
    const coinEarn = Math.round((2 + (result.finalScore/12)) * diffMult);

    S.progress.xp += xpEarn;
    S.progress.coins += coinEarn;

    // streak: daily quest completion triggers, but also count any play once/day
    const day = todayKey();
    if(S.progress.lastQuestDay !== day){
      // Don't auto-increase streak just for one play; streak tied to daily quest completion
      // But we can track "active day" for future expansion
    }

    persistProgress();
    updateKPIs();

    // league
    updateLeaguePill();
    $('rewardCoinsPill').textContent = `ü™ô ${S.progress.coins}`;
    $('mReward').textContent = `You earned +${xpEarn} XP and +${coinEarn} coins!`;
  }

  function levelFromXP(xp){
    return Math.floor(Math.max(0,xp)/220) + 1;
  }

  function updateKPIs(){
    $('kpiXP').textContent = S.progress.xp;
    $('kpiCoins').textContent = S.progress.coins;
    $('kpiLevel').textContent = levelFromXP(S.progress.xp);
    $('rewardCoinsPill').textContent = `ü™ô ${S.progress.coins}`;
    $('pillStreak').textContent = `Streak ${S.progress.streak}`;
  }

  function updateLeaguePill(){
    const lvl = levelFromXP(S.progress.xp);
    const league = lvl >= 12 ? 'Diamond League'
                 : lvl >= 8 ? 'Gold League'
                 : lvl >= 4 ? 'Silver League'
                 : 'Bronze League';
    $('pillLeague').textContent = league;
  }

  // ---------- Leaderboard (local-first) ----------
  function persistLeaderboard(){
    writeJSON(K.leaderboard, S.leaderboard);
  }
  function loadLeaderboard(){
    S.leaderboard = readJSON(K.leaderboard, { entries: [] });
  }

  function addLeaderboardEntry(result){
    // Keep best per profile per challenge per week, plus store raw attempts (limit)
    const weekKey = getWeekKey(result.timestamp);
    const e = {
      id: result.id,
      week: weekKey,
      profileId: result.profileId,
      profileName: getProfileName(result.profileId),
      state: S.selectedState,
      type: result.type,
      challengeId: result.challengeId,
      score: result.finalScore,
      accuracy: result.accuracy,
      timeMs: result.elapsedMs,
      ts: result.timestamp,
    };
    S.leaderboard.entries.push(e);

    // Trim old attempts (keep last 250)
    if(S.leaderboard.entries.length > 250){
      S.leaderboard.entries = S.leaderboard.entries.slice(-250);
    }
    persistLeaderboard();
    renderLeaderboard();
  }

  function getWeekKey(ts){
    const d = new Date(ts);
    // ISO week-ish: use Monday start
    const day = (d.getDay() + 6) % 7;
    d.setDate(d.getDate() - day);
    const y = d.getFullYear();
    const m = String(d.getMonth()+1).padStart(2,'0');
    const dd = String(d.getDate()).padStart(2,'0');
    return `${y}-${m}-${dd}`; // monday date as week id
  }

  function renderLeaderboard(){
    const scope = $('lbScope').value;
    const mode = $('lbMode').value;
    const list = $('lbList');
    list.innerHTML = '';

    const currentWeek = getWeekKey(Date.now());

    // Filter local entries
    let entries = S.leaderboard.entries.slice();

    // mode filter
    if(mode !== 'all'){
      entries = entries.filter(e => e.type === mode);
    }

    // scope note
    const note = $('lbNote');
    if(scope === 'local'){
      note.textContent = 'Local leaderboard: compares profiles on this device.';
    }else{
      // No backend in this HTML-only file
      note.textContent = 'State/Global leaderboards need a backend (Firebase/Firestore). This UI is ready; wire the network calls later.';
      // For now, still show local entries (transparent)
    }

    // Compute weekly best per profile
    const weekEntries = entries.filter(e => e.week === currentWeek);
    const bestByProfile = new Map();
    for(const e of weekEntries){
      const key = e.profileId;
      const prev = bestByProfile.get(key);
      if(!prev || e.score > prev.score) bestByProfile.set(key, e);
    }

    const ranking = Array.from(bestByProfile.values()).sort((a,b) => b.score - a.score);

    // KPIs
    const active = S.activeProfileId;
    const myBest = weekEntries.filter(e=>e.profileId===active).reduce((m,e)=>Math.max(m,e.score), 0);
    const weeklyPoints = weekEntries.filter(e=>e.profileId===active).reduce((s,e)=>s+e.score, 0);
    const myRank = ranking.findIndex(e=>e.profileId===active) + 1;

    $('lbBest').textContent = myBest ? `${myBest}` : '‚Äî';
    $('lbWeekly').textContent = weeklyPoints ? `${weeklyPoints}` : '‚Äî';
    $('lbRank').textContent = myRank ? `#${myRank}` : '‚Äî';

    if(ranking.length === 0){
      const empty = document.createElement('div');
      empty.className = 'muted tiny';
      empty.textContent = 'No scores yet. Play a challenge and finish it to appear here.';
      list.appendChild(empty);
      return;
    }

    ranking.forEach((e, idx) => {
      const div = document.createElement('div');
      div.className = 'item';
      const medal = idx === 0 ? 'ü•á' : idx === 1 ? 'ü•à' : idx === 2 ? 'ü•â' : 'üèÖ';
      const isMe = e.profileId === S.activeProfileId;
      div.innerHTML = `
        <div class="row" style="justify-content:space-between; align-items:flex-start;">
          <div style="flex:1;">
            <h4>${medal} #${idx+1} ‚Ä¢ ${escapeHtml(e.profileName)} ${isMe ? ' (You)' : ''}</h4>
            <p>${escapeHtml(e.type === 'draw' ? 'Draw Sprint' : 'Color Match')} ‚Ä¢ Best Score ${e.score}</p>
          </div>
          <div class="col" style="gap:6px; align-items:flex-end;">
            <span class="pill pill-emerald">Score ${e.score}</span>
            <span class="pill">${escapeHtml(S.selectedState)}</span>
          </div>
        </div>
      `;
      list.appendChild(div);
    });

    renderProfiles(); // keep profile view synced
  }

  // ---------- Gallery ----------
  function getGallery(){ return readJSON(K.gallery, []); }
  function renderGallery(){
    const grid = $('galleryGrid');
    grid.innerHTML = '';
    const items = getGallery().slice().reverse();

    $('galleryEmpty').classList.toggle('hide', items.length !== 0);

    // responsive columns
    const w = window.innerWidth;
    const cols = w >= 920 ? 4 : w >= 520 ? 3 : 2;
    grid.style.gridTemplateColumns = `repeat(${cols}, 1fr)`;

    items.forEach((it) => {
      const div = document.createElement('div');
      div.className = 'card';
      div.style.overflow = 'hidden';
      div.innerHTML = `
        <img src="${it.dataUrl}" alt="Saved Art" style="width:100%; height:140px; object-fit:cover;" />
        <div style="padding:10px;" class="row">
          <div style="flex:1;">
            <div style="font-weight:1000; font-size:12px;">${escapeHtml(it.title || 'Art')}</div>
            <div class="muted tiny">${new Date(it.ts).toLocaleString()}</div>
          </div>
          <button class="btn btn-ghost btn-small" title="Delete">üóëÔ∏è</button>
        </div>
      `;
      div.querySelector('button').addEventListener('click', () => {
        const arr = getGallery().filter(x => x.ts !== it.ts);
        writeJSON(K.gallery, arr);
        renderGallery();
      });
      grid.appendChild(div);
    });
  }

  function saveToGallery(){
    if(!S.challenge){ toast('Pick a challenge first.'); return; }
    const png = exportPNG(true);
    if(!png) return;
    const items = getGallery();
    items.push({
      ts: Date.now(),
      title: `${S.challenge.title} ‚Ä¢ ${S.challenge.type === 'draw' ? 'Draw' : 'Color'}`,
      dataUrl: png
    });
    writeJSON(K.gallery, items);
    renderGallery();
    toast('Saved to Gallery üñºÔ∏è');
  }

  function exportPNG(silent){
    try{
      // composite base + user + fx into a single PNG
      const c = document.createElement('canvas');
      c.width = base.width;
      c.height = base.height;
      const ctx = c.getContext('2d');
      ctx.drawImage(base,0,0);
      ctx.drawImage(user,0,0);
      ctx.drawImage(fx,0,0);
      const url = c.toDataURL('image/png');

      if(!silent){
        // In iOS WKWebView, downloading may not work; we still open in new tab if possible.
        const a = document.createElement('a');
        a.href = url;
        a.download = 'drawing.png';
        document.body.appendChild(a);
        a.click();
        a.remove();
        toast('Exported PNG ‚úÖ');
      }
      return url;
    }catch(e){
      toast('Export not available on this device.');
      return null;
    }
  }

  // ---------- Shop / Cosmetics ----------
  function persistProgress(){ writeJSON(K.progress, S.progress); }
  function loadProgress(){
    S.progress = readJSON(K.progress, S.progress);
    // normalize
    S.progress.unlockedCosmetics = S.progress.unlockedCosmetics || [];
    S.progress.equippedFrame = S.progress.equippedFrame || 'none';
  }

  function renderShop(){
    const grid = $('shopGrid');
    grid.innerHTML = '';

    SHOP_ITEMS.forEach(item => {
      const owned = S.progress.unlockedCosmetics.includes(item.id);
      const div = document.createElement('div');
      div.className = 'card';
      div.style.padding = '12px';
      div.style.borderRadius = '18px';
      div.innerHTML = `
        <div style="font-weight:1000;">${escapeHtml(item.name)}</div>
        <div class="muted tiny" style="margin-top:4px;">${escapeHtml(item.desc)}</div>
        <div class="space"></div>
        <div class="row" style="justify-content:space-between;">
          <span class="pill pill-amber">ü™ô ${item.cost}</span>
          <button class="btn ${owned ? 'btn-ghost' : 'btn-emerald'} btn-small">${owned ? 'Owned' : 'Buy'}</button>
        </div>
      `;
      const btn = div.querySelector('button');
      btn.addEventListener('click', () => {
        if(owned){
          equipItem(item.id);
          return;
        }
        if(S.progress.coins < item.cost){
          toast('Not enough coins yet.');
          return;
        }
        S.progress.coins -= item.cost;
        S.progress.unlockedCosmetics.push(item.id);
        persistProgress();
        updateKPIs();
        renderShop();
        renderUnlocked();
        toast(`Unlocked: ${item.name} ‚úÖ`);
      });
      grid.appendChild(div);
    });

    renderUnlocked();
  }

  function equipItem(id){
    if(id.startsWith('frame_')){
      S.progress.equippedFrame = id;
      persistProgress();
      renderFX(false);
      toast('Equipped frame ‚úÖ');
    }else{
      toast('Equipped ‚úÖ');
    }
    renderUnlocked();
  }

  function renderUnlocked(){
    const owned = S.progress.unlockedCosmetics || [];
    const frame = S.progress.equippedFrame || 'none';
    $('unlockedList').textContent =
      owned.length
        ? `Owned: ${owned.join(', ')} ‚Ä¢ Equipped frame: ${frame}`
        : `Owned: none ‚Ä¢ Equipped frame: ${frame}`;
  }

  // ---------- Daily Quest ----------
  function loadDaily(){
    const d = readJSON(K.daily, null);
    return d;
  }
  function saveDaily(d){
    writeJSON(K.daily, d);
  }

  function generateDailyQuest(forceNew){
    const day = todayKey();
    let d = loadDaily();

    if(!d || forceNew || d.day !== day){
      // pick 3 unique challenges
      const pool = CHALLENGES.slice();
      shuffle(pool);
      const picks = pool.slice(0, 3).map(c => ({
        id: c.id,
        type: c.type,
        title: c.title,
        done: false,
        bestScore: 0
      }));
      d = { day, picks, started: false, completed: false };
      saveDaily(d);
    }

    renderDailyQuest();
  }

  function renderDailyQuest(){
    const d = loadDaily();
    const list = $('dailyQuestList');
    list.innerHTML = '';

    if(!d){
      const div = document.createElement('div');
      div.className = 'muted tiny';
      div.textContent = 'No quest yet.';
      list.appendChild(div);
      return;
    }

    d.picks.forEach((p, idx) => {
      const div = document.createElement('div');
      div.className = 'item';
      div.innerHTML = `
        <div class="row" style="justify-content:space-between; align-items:flex-start;">
          <div style="flex:1;">
            <h4>${p.done ? '‚úÖ' : '‚¨ú'} ${idx+1}. ${escapeHtml(p.title)}</h4>
            <p>${p.type === 'draw' ? 'Draw Sprint' : 'Color Match'} ‚Ä¢ Best ${p.bestScore || 0}</p>
          </div>
          <span class="pill ${p.type==='draw'?'pill-sky':'pill-amber'}">${p.type==='draw'?'‚úçÔ∏è':'üß©'}</span>
        </div>
      `;
      div.addEventListener('click', () => {
        selectChallenge(p.id);
        showTab('play');
      });
      list.appendChild(div);
    });

    $('btnStartQuest').textContent = d.completed ? '‚úÖ Quest Complete' : (d.started ? 'Continue Quest' : 'üöÄ Start Daily Quest');
  }

  function startDailyQuest(){
    const d = loadDaily();
    if(!d) return;
    if(d.completed){ toast('Quest already complete ‚úÖ'); return; }
    d.started = true;
    saveDaily(d);
    renderDailyQuest();

    // go to first not-done
    const next = d.picks.find(p => !p.done);
    if(next){ selectChallenge(next.id); showTab('play'); }
  }

  function updateQuestProgress(result){
    const d = loadDaily();
    if(!d || d.day !== todayKey()) return;

    const pick = d.picks.find(p => p.id === result.challengeId);
    if(!pick) return;

    pick.bestScore = Math.max(pick.bestScore || 0, result.finalScore);

    // consider done if score >= 60 (kid-friendly)
    if(result.finalScore >= 60) pick.done = true;

    // completed?
    if(d.picks.every(p => p.done)){
      if(!d.completed){
        d.completed = true;

        // streak increments on completion (not punishing if miss a day)
        const prevDay = S.progress.lastQuestDay;
        const day = todayKey();
        if(prevDay){
          const prev = new Date(prevDay);
          const now = new Date(day);
          const diff = Math.round((now - prev) / (24*3600*1000));
          if(diff === 1) S.progress.streak += 1;
          else S.progress.streak = 1;
        }else{
          S.progress.streak = 1;
        }
        S.progress.lastQuestDay = day;

        // bonus
        S.progress.coins += 45;
        S.progress.xp += 120;
        persistProgress();
        updateKPIs();
        updateLeaguePill();

        toast('Daily Quest Complete! +Bonus coins ü™ô');
        popConfetti();
      }
    }

    saveDaily(d);
    renderDailyQuest();
  }

  // ---------- Result Modal ----------
  function showResultModal(result){
    $('resultTitle').textContent = `${result.title} ‚Ä¢ ${result.type === 'draw' ? 'Draw Sprint' : 'Color Match'}`;

    setRing($('modalRing'), $('modalRingText'), result.finalScore);
    $('mAcc').textContent = `üéØ Acc: ${result.accuracy}%`;
    $('mTime').textContent = `‚è±Ô∏è Time: ${fmtTime(result.elapsedMs)} / ${fmtTime(S.challenge.timeLimit)}`;
    $('mNeat').textContent = `‚ú® Neat: ${result.neatness}%`;
    $('mFinal').textContent = `üèÜ Final: ${result.finalScore}`;

    $('resultBackdrop').classList.add('show');
  }

  function closeResult(){
    $('resultBackdrop').classList.remove('show');
  }

  function setScoreUI(result){
    if(!result){
      setRing($('scoreRing'), $('scoreRingText'), 0, true);
      $('scoreAcc').textContent = `üéØ Acc: ‚Äî`;
      $('scoreTime').textContent = `‚è±Ô∏è Time: ‚Äî`;
      $('scoreNeat').textContent = `‚ú® Neat: ‚Äî`;
      $('scoreFinal').textContent = `üèÜ Final: ‚Äî`;
      return;
    }
    setRing($('scoreRing'), $('scoreRingText'), result.finalScore);
    $('scoreAcc').textContent = `üéØ Acc: ${result.accuracy}%`;
    $('scoreTime').textContent = `‚è±Ô∏è Time: ${fmtTime(result.elapsedMs)}`;
    $('scoreNeat').textContent = `‚ú® Neat: ${result.neatness}%`;
    $('scoreFinal').textContent = `üèÜ Final: ${result.finalScore}`;
    $('pillAccuracy').textContent = `Accuracy: ${result.accuracy}%`;
  }

  function setRing(ringEl, textEl, score, blank){
    if(blank){
      ringEl.style.background = `conic-gradient(rgba(2,6,23,.12) 0deg, rgba(2,6,23,.12) 0deg)`;
      textEl.textContent = '‚Äî';
      return;
    }
    const deg = clamp(score, 0, 100) * 3.6;
    const color = score >= 85 ? 'rgba(16,185,129,1)'
                : score >= 70 ? 'rgba(245,158,11,1)'
                : score >= 50 ? 'rgba(56,189,248,1)'
                : 'rgba(251,113,133,1)';
    ringEl.style.background = `conic-gradient(${color} ${deg}deg, rgba(2,6,23,.10) ${deg}deg)`;
    textEl.textContent = String(score);
  }

  function nextChallenge(){
    const items = filteredChallenges();
    if(!items.length) return;
    const idx = items.findIndex(x => x.id === S.challenge?.id);
    const next = items[(idx + 1) % items.length];
    selectChallenge(next.id);
  }
  function replayChallenge(){
    if(!S.challenge) return;
    selectChallenge(S.challenge.id);
  }

  // ---------- Toast ----------
  let toastTimer = null;
  function toast(msg){
    $('proTip').textContent = msg;
    clearTimeout(toastTimer);
    toastTimer = setTimeout(() => {
      if(S.challenge){
        $('proTip').textContent = S.challenge.type === 'draw'
          ? 'Try smooth strokes. Staying inside the guide boosts accuracy.'
          : 'Use the preview in the top-right. Accuracy matters more than speed on hard mode.';
      }else{
        $('proTip').textContent = 'Pick a challenge and hit Start. Try to stay inside the guide!';
      }
    }, 1800);
  }

  function confirmSafe(msg){
    // In kid apps, confirm dialogs should be parent-only; we assume this is clicked in Parent tab or parent unlocked.
    return window.confirm(msg);
  }

  // ---------- Parent Gate / Kids Mode / Ads ----------
  const ParentGate = { a:0, b:0 };
  function resetGate(){
    ParentGate.a = 2 + Math.floor(Math.random()*8);
    ParentGate.b = 2 + Math.floor(Math.random()*8);
    $('gateQ').textContent = `What is ${ParentGate.a} + ${ParentGate.b}?`;
    $('gateA').value = '';
    $('gateMsg').textContent = '';
  }

  function parentUnlockAttempt(){
    const val = parseInt(($('gateA').value || '0'), 10);
    if(val === ParentGate.a + ParentGate.b){
      setParentUnlocked(true);
      $('gateMsg').textContent = 'Unlocked ‚úÖ';
    }else{
      $('gateMsg').textContent = 'Try again.';
      resetGate();
    }
  }

  function setParentUnlocked(on){
    S.parentUnlocked = !!on;
    localStorage.setItem(K.unlocked, S.parentUnlocked ? '1' : '0');
    $('parentLockPill').textContent = S.parentUnlocked ? 'üîì Unlocked' : 'üîí Locked';
    $('parentLockPill').className = S.parentUnlocked ? 'pill pill-emerald' : 'pill pill-rose';
    $('parentSettings').classList.toggle('hide', !S.parentUnlocked);

    refreshAdsVisibility();
    renderDailyQuest(); // keep buttons accurate
  }

  function setKidsMode(on){
    S.kidsMode = !!on;
    localStorage.setItem(K.kids, S.kidsMode ? '1' : '0');
    $('pillKids').textContent = S.kidsMode ? 'Kids Mode' : 'Free Mode';
    $('pillKids').className = S.kidsMode ? 'pill pill-sky' : 'pill pill-amber';

    // In kids mode, we keep leaderboard scope local
    if(S.kidsMode){
      $('lbScope').value = 'local';
    }
    refreshAdsVisibility();
    toast(S.kidsMode ? 'Kids Mode ON ‚úÖ' : 'Kids Mode OFF ‚úÖ');
  }

  function refreshAdsVisibility(){
    const allowAds = S.parentUnlocked && !S.kidsMode;
    $('adBanner').classList.toggle('show', allowAds);
    $('adReward').classList.toggle('show', allowAds);
  }

  // Ad hooks: wire these to Capacitor AdMob plugin later
  const Ads = {
    showBanner(){ if(S.kidsMode) return toast('Kids Mode: ads are hidden.'); $('adBanner').classList.add('show'); toast('Banner requested (hook).'); },
    hideBanner(){ $('adBanner').classList.remove('show'); toast('Banner hidden (hook).'); },
    showInterstitial(){ if(S.kidsMode) return toast('Kids Mode: interstitial blocked.'); toast('Interstitial requested (hook).'); },
    showRewarded(){ if(S.kidsMode) return toast('Kids Mode: rewarded blocked.'); $('adReward').classList.add('show'); toast('Rewarded requested (hook).'); },
  };
  window.Ads = Ads;

  // ---------- Profiles ----------
  function loadProfiles(){
    const p = readJSON(K.profiles, null);
    if(p && Array.isArray(p) && p.length){
      S.profiles = p;
    }else{
      // default profile
      S.profiles = [{ id: uid(), name: makeFunName() }];
      writeJSON(K.profiles, S.profiles);
    }

    const active = localStorage.getItem(K.activeProfile);
    if(active && S.profiles.some(x => x.id === active)){
      S.activeProfileId = active;
    }else{
      S.activeProfileId = S.profiles[0].id;
      localStorage.setItem(K.activeProfile, S.activeProfileId);
    }
  }

  function persistProfiles(){
    writeJSON(K.profiles, S.profiles);
    localStorage.setItem(K.activeProfile, S.activeProfileId);
  }

  function addProfile(){
    const name = makeFunName();
    S.profiles.push({ id: uid(), name });
    S.activeProfileId = S.profiles[S.profiles.length - 1].id;
    persistProfiles();
    updateProfilePill();
    toast(`Added profile: ${name}`);
  }

  function makeFunName(){
    const a = ['Blue','Sunny','Sparkle','Brave','Happy','Tiny','Mighty','Cosmic','Silly','Rainbow','Swift','Cool'];
    const b = ['Panda','Tiger','Shark','Bunny','Dragon','Fox','Otter','Koala','Unicorn','Dino','Penguin','Kitten'];
    const n = Math.floor(Math.random()*900 + 100);
    return `${a[Math.floor(Math.random()*a.length)]}${b[Math.floor(Math.random()*b.length)]}${n}`;
  }

  function getProfileName(id){
    return S.profiles.find(p => p.id === id)?.name || 'Player';
  }

  function updateProfilePill(){
    $('pillProfile').textContent = `üôÇ ${getProfileName(S.activeProfileId)}`;
  }

  function renderProfiles(){
    const list = $('profileList');
    if(!list) return;
    list.innerHTML = '';

    S.profiles.forEach(p => {
      const div = document.createElement('div');
      div.className = 'item';
      div.innerHTML = `
        <div class="row" style="justify-content:space-between;">
          <div>
            <h4>${escapeHtml(p.name)} ${p.id === S.activeProfileId ? '(Active)' : ''}</h4>
            <p>Local profile</p>
          </div>
          <div class="row" style="gap:8px;">
            <button class="btn btn-ghost btn-small">${p.id === S.activeProfileId ? '‚úÖ' : 'Use'}</button>
            <button class="btn btn-ghost btn-small" title="Delete">üóëÔ∏è</button>
          </div>
        </div>
      `;

      const [useBtn, delBtn] = div.querySelectorAll('button');
      useBtn.addEventListener('click', () => {
        S.activeProfileId = p.id;
        persistProfiles();
        updateProfilePill();
        renderProfiles();
        renderLeaderboard();
      });

      delBtn.addEventListener('click', () => {
        if(S.profiles.length <= 1){ toast('Need at least 1 profile.'); return; }
        if(!confirmSafe('Delete this profile?')) return;
        S.profiles = S.profiles.filter(x => x.id !== p.id);
        if(S.activeProfileId === p.id) S.activeProfileId = S.profiles[0].id;
        persistProfiles();
        updateProfilePill();
        renderProfiles();
        renderLeaderboard();
      });

      list.appendChild(div);
    });
  }

  // ---------- State Dropdown ----------
  function loadStates(){
    const states = [
      "AL","AK","AZ","AR","CA","CO","CT","DE","FL","GA","HI","ID","IL","IN","IA","KS","KY","LA","ME","MD",
      "MA","MI","MN","MS","MO","MT","NE","NV","NH","NJ","NM","NY","NC","ND","OH","OK","OR","PA","RI","SC",
      "SD","TN","TX","UT","VT","VA","WA","WV","WI","WY"
    ];
    const sel = $('stateSelect');
    sel.innerHTML = states.map(s => `<option value="${s}">${s}</option>`).join('');
    S.selectedState = localStorage.getItem(K.state) || 'TX';
    sel.value = S.selectedState;
  }

  // ---------- Daily Quest / Finish Hook ----------
  function onResult(result){
    // Update quest
    updateQuestProgress(result);
  }

  // ---------- Confetti ----------
  function popConfetti(){
    const host = $('confetti');
    host.innerHTML = '';
    host.classList.add('show');
    const colors = ['#0ea5e9','#38bdf8','#f59e0b','#10b981','#fb7185','#a78bfa'];
    const count = 24;
    for(let i=0;i<count;i++){
      const el = document.createElement('i');
      el.style.left = Math.floor(Math.random()*100) + 'vw';
      el.style.background = colors[i % colors.length];
      el.style.animationDuration = (0.9 + Math.random()*0.7) + 's';
      el.style.transform = `translateY(0) rotate(${Math.floor(Math.random()*180)}deg)`;
      host.appendChild(el);
    }
    setTimeout(() => host.classList.remove('show'), 1300);
  }

  // ---------- Finish integration ----------
  function showResultModal(result){
    // call hook
    onResult(result);

    $('resultTitle').textContent = `${result.title} ‚Ä¢ ${result.type === 'draw' ? 'Draw Sprint' : 'Color Match'}`;

    setRing($('modalRing'), $('modalRingText'), result.finalScore);
    $('mAcc').textContent = `üéØ Acc: ${result.accuracy}%`;
    $('mTime').textContent = `‚è±Ô∏è Time: ${fmtTime(result.elapsedMs)} / ${fmtTime(S.challenge.timeLimit)}`;
    $('mNeat').textContent = `‚ú® Neat: ${result.neatness}%`;
    $('mFinal').textContent = `üèÜ Final: ${result.finalScore}`;

    $('resultBackdrop').classList.add('show');
  }

  // ---------- Procedural Fallback Art ----------
  function drawContain(ctx, img, w, h, scale=0.9, multiply){
    const iw = img.width, ih = img.height;
    const s = Math.min(w/iw, h/ih) * scale;
    const dw = iw*s, dh = ih*s;
    const x = (w - dw)/2;
    const y = (h - dh)/2;

    ctx.save();
    if(multiply){
      ctx.globalCompositeOperation = 'multiply';
    }
    ctx.globalAlpha = 1;
    ctx.drawImage(img, x, y, dw, dh);
    ctx.restore();
  }

  function drawContainInRect(ctx, img, x, y, w, h){
    const iw = img.width, ih = img.height;
    const s = Math.min(w/iw, h/ih);
    const dw = iw*s, dh = ih*s;
    const ox = x + (w - dw)/2;
    const oy = y + (h - dh)/2;
    ctx.drawImage(img, ox, oy, dw, dh);
  }

  function roundRect(ctx, x, y, w, h, r){
    const rr = Math.min(r, w/2, h/2);
    ctx.beginPath();
    ctx.moveTo(x+rr, y);
    ctx.arcTo(x+w, y, x+w, y+h, rr);
    ctx.arcTo(x+w, y+h, x, y+h, rr);
    ctx.arcTo(x, y+h, x, y, rr);
    ctx.arcTo(x, y, x+w, y, rr);
    ctx.closePath();
  }

  function drawProceduralGuide(ctx, id, w, h, maskOnly){
    // draws simple line art shapes; if maskOnly true draw thicker strokes for mask derivation
    ctx.save();
    ctx.clearRect(0,0,w,h);
    ctx.lineWidth = maskOnly ? 18 : 6;
    ctx.strokeStyle = 'rgba(15,23,42,.78)';
    ctx.lineCap = 'round';
    ctx.lineJoin = 'round';
    ctx.globalAlpha = maskOnly ? 1 : 0.55;

    const cx = w/2, cy = h/2;
    if(id === 'cat'){
      // head
      ctx.beginPath();
      ctx.ellipse(cx, cy, w*0.18, h*0.20, 0, 0, Math.PI*2);
      ctx.stroke();
      // ears
      ctx.beginPath();
      ctx.moveTo(cx-w*0.12, cy-h*0.14);
      ctx.lineTo(cx-w*0.20, cy-h*0.30);
      ctx.lineTo(cx-w*0.04, cy-h*0.22);
      ctx.stroke();

      ctx.beginPath();
      ctx.moveTo(cx+w*0.12, cy-h*0.14);
      ctx.lineTo(cx+w*0.20, cy-h*0.30);
      ctx.lineTo(cx+w*0.04, cy-h*0.22);
      ctx.stroke();
      // whiskers
      ctx.lineWidth = maskOnly ? 10 : 3;
      ctx.beginPath();
      ctx.moveTo(cx-w*0.05, cy+h*0.02); ctx.lineTo(cx-w*0.22, cy-h*0.02);
      ctx.moveTo(cx-w*0.05, cy+h*0.05); ctx.lineTo(cx-w*0.22, cy+h*0.05);
      ctx.moveTo(cx+w*0.05, cy+h*0.02); ctx.lineTo(cx+w*0.22, cy-h*0.02);
      ctx.moveTo(cx+w*0.05, cy+h*0.05); ctx.lineTo(cx+w*0.22, cy+h*0.05);
      ctx.stroke();
    } else if(id === 'shark'){
      ctx.beginPath();
      ctx.moveTo(cx-w*0.28, cy+h*0.06);
      ctx.quadraticCurveTo(cx-w*0.10, cy-h*0.22, cx+w*0.28, cy-h*0.02);
      ctx.quadraticCurveTo(cx+w*0.10, cy+h*0.22, cx-w*0.28, cy+h*0.06);
      ctx.stroke();
      // fin
      ctx.beginPath();
      ctx.moveTo(cx-w*0.02, cy-h*0.18);
      ctx.lineTo(cx+w*0.10, cy-h*0.34);
      ctx.lineTo(cx+w*0.12, cy-h*0.14);
      ctx.stroke();
      // mouth
      ctx.lineWidth = maskOnly ? 14 : 5;
      ctx.beginPath();
      ctx.arc(cx+w*0.06, cy+h*0.06, w*0.12, Math.PI*0.12, Math.PI*0.92);
      ctx.stroke();
    } else {
      // car
      ctx.beginPath();
      ctx.roundRect(cx-w*0.26, cy-h*0.05, w*0.52, h*0.18, 22);
      ctx.stroke();
      ctx.beginPath();
      ctx.moveTo(cx-w*0.16, cy-h*0.05);
      ctx.lineTo(cx-w*0.06, cy-h*0.18);
      ctx.lineTo(cx+w*0.12, cy-h*0.18);
      ctx.lineTo(cx+w*0.20, cy-h*0.05);
      ctx.stroke();
      // wheels
      ctx.lineWidth = maskOnly ? 18 : 6;
      ctx.beginPath();
      ctx.arc(cx-w*0.16, cy+h*0.14, w*0.06, 0, Math.PI*2);
      ctx.arc(cx+w*0.16, cy+h*0.14, w*0.06, 0, Math.PI*2);
      ctx.stroke();
    }
    ctx.restore();
  }

  function drawProceduralLineArt(ctx, id, w, h){
    // simple outlines for color mode
    ctx.save();
    ctx.clearRect(0,0,w,h);
    ctx.lineWidth = 4;
    ctx.strokeStyle = 'rgba(15,23,42,.75)';
    ctx.lineCap='round'; ctx.lineJoin='round';

    const cx = w/2, cy = h/2;
    // a ‚Äúscene‚Äù with three regions: sky, ground, object
    ctx.beginPath();
    ctx.roundRect(w*0.12, h*0.12, w*0.76, h*0.76, 18);
    ctx.stroke();

    // horizon
    ctx.beginPath();
    ctx.moveTo(w*0.12, h*0.54);
    ctx.lineTo(w*0.88, h*0.54);
    ctx.stroke();

    // center object
    ctx.beginPath();
    ctx.arc(cx, cy, Math.min(w,h)*0.14, 0, Math.PI*2);
    ctx.stroke();

    ctx.restore();
  }

  function drawProceduralTarget(ctx, id, w, h){
    // colored target for accuracy scoring
    ctx.save();
    ctx.clearRect(0,0,w,h);
    // sky
    ctx.fillStyle = id === 'sunset' ? '#fb7185' : id === 'space' ? '#0b1220' : '#38bdf8';
    ctx.fillRect(0,0,w,h*0.54);
    // ground
    ctx.fillStyle = id === 'jungle' ? '#10b981' : '#f59e0b';
    ctx.fillRect(0,h*0.54,w,h*0.46);
    // object
    ctx.fillStyle = id === 'space' ? '#a78bfa' : '#0ea5e9';
    ctx.beginPath();
    ctx.arc(w/2, h/2, Math.min(w,h)*0.14, 0, Math.PI*2);
    ctx.fill();
    ctx.restore();
  }

  function drawProceduralTargetPreview(ctx, id, x, y, w, h){
    const tmp = document.createElement('canvas');
    tmp.width = w; tmp.height = h;
    const tctx = tmp.getContext('2d');
    drawProceduralTarget(tctx, id, w, h);
    ctx.drawImage(tmp, x, y);
  }

  function drawProceduralMask(ctx, id, w, h){
    // allow all pixels except small border
    ctx.save();
    ctx.clearRect(0,0,w,h);
    ctx.fillStyle = 'rgba(255,255,255,1)';
    ctx.fillRect(w*0.06, h*0.06, w*0.88, h*0.88);
    ctx.restore();
  }

  function shuffle(arr){
    for(let i=arr.length-1;i>0;i--){
      const j = Math.floor(Math.random()*(i+1));
      [arr[i],arr[j]] = [arr[j],arr[i]];
    }
  }

  function escapeHtml(str){
    return String(str||'')
      .replaceAll('&','&amp;')
      .replaceAll('<','&lt;')
      .replaceAll('>','&gt;')
      .replaceAll('"','&quot;')
      .replaceAll("'","&#039;");
  }

  // ---------- Init ----------
  function init(){
    // load settings
    S.kidsMode = (localStorage.getItem(K.kids) ?? '1') === '1';
    S.parentUnlocked = (localStorage.getItem(K.unlocked) ?? '0') === '1';

    loadStates();
    resetGate();

    loadProfiles();
    loadProgress();
    loadLeaderboard();

    updateKPIs();
    updateLeaguePill();
    updateProfilePill();

    // set parent unlocked
    setParentUnlocked(S.parentUnlocked);
    setKidsMode(S.kidsMode);

    // daily quest
    generateDailyQuest(false);

    // build challenge list
    renderChallengeList();

    // shop
    renderShop();

    // gallery
    renderGallery();

    // leaderboard
    renderLeaderboard();

    // initial base
    resizeCanvases();

    // modal close on backdrop click
    $('resultBackdrop').addEventListener('click', (e) => {
      if(e.target === $('resultBackdrop')) closeResult();
    });
  }

  init();
})();
</script>
</body>
</html>
